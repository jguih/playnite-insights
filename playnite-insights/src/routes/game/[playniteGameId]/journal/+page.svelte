<script lang="ts">
	import {
		companySignal,
		factory,
		gameSignal,
		indexedDbSignal,
		recentGameSessionSignal,
		serverTimeSignal,
	} from '$lib/client/app-state/AppData.svelte';
	import { toast } from '$lib/client/app-state/toast.svelte.js';
	import LightButton from '$lib/client/components/buttons/LightButton.svelte';
	import Divider from '$lib/client/components/Divider.svelte';
	import { GameNoteEditor } from '$lib/client/components/game-page/journal/gameNoteEditor.svelte.js';
	import NoteEditor from '$lib/client/components/game-page/journal/NoteEditor.svelte';
	import Header from '$lib/client/components/Header.svelte';
	import BaseAppLayout from '$lib/client/components/layout/BaseAppLayout.svelte';
	import Main from '$lib/client/components/Main.svelte';
	import { IndexedDBNotInitializedError } from '$lib/client/db/errors/indexeddbNotInitialized.js';
	import { GameNoteRepository } from '$lib/client/db/gameNotesRepository.svelte.js';
	import { DateTimeHandler } from '$lib/client/utils/dateTimeHandler.svelte.js';
	import {
		getPlayniteGameImageUrl,
		getPlaytimeInHoursMinutesAndSeconds,
	} from '$lib/client/utils/playnite-game';
	import { GamePageViewModel } from '$lib/client/viewmodel/gamePageViewModel.svelte';
	import { RecentActivityViewModel } from '$lib/client/viewmodel/recentActivityViewModel.svelte.js';
	import { m } from '$lib/paraglide/messages.js';
	import { ArrowLeft } from '@lucide/svelte';
	import { type GameNote } from '@playnite-insights/lib/client';
	import { onMount } from 'svelte';

	const { data } = $props();
	const dateTimeHandler = new DateTimeHandler({ serverTimeSignal: serverTimeSignal });
	const notesRepo = new GameNoteRepository({
		indexedDbSignal: indexedDbSignal,
		syncQueueFactory: factory.syncQueue,
	});
	const pageVm = new GamePageViewModel({
		getGameId: () => data.gameId,
		gamesSignal: gameSignal,
		companySignal: companySignal,
	});
	const activityVm = new RecentActivityViewModel({
		gameSignal: gameSignal,
		recentGameSessionSignal: recentGameSessionSignal,
		dateTimeHandler: dateTimeHandler,
	});
	const noteEditorHandler = new GameNoteEditor({
		gameNoteFactory: factory.gameNote,
		gameNoteRepository: notesRepo,
	});
	const isThisGameActive = $derived.by(() => {
		const inProgressActivity = activityVm.inProgressActivity;
		return inProgressActivity?.gameId === data.gameId;
	});
	const activeSessionForThisGame = $derived.by(() => {
		if (!isThisGameActive) return null;
		const session = activityVm.inProgressSession;
		return session;
	});
	const todaySessionsCount = $derived.by(() => {
		const recentActivityMap = activityVm.recentActivityMap;
		const activityForThisGame = recentActivityMap.get(data.gameId);
		return activityForThisGame?.sessions.length ?? 0;
	});
	const notesSignal = $state<{ notes: GameNote[]; isLoading: boolean }>({
		notes: [],
		isLoading: false,
	});

	const loadNotes = async () => {
		const gameId = data.gameId;
		try {
			notesSignal.isLoading = true;
			const notes = await notesRepo.getAllAsync({ filterBy: 'byGameId', GameId: gameId });
			notesSignal.notes = notes;
		} catch (err) {
			if (err instanceof IndexedDBNotInitializedError) {
				toast.error({ message: 'Database not ready, please refresh the app' });
			} else if (err instanceof Error) {
				toast.error({ title: 'Failed to load game notes', message: err.message });
			}
		} finally {
			notesSignal.isLoading = false;
		}
	};

	const handleOnNoteChange = async () => {
		const gameId = data.gameId;
		const sessionId = activeSessionForThisGame?.SessionId ?? null;
		await noteEditorHandler.saveAsync({ gameId, sessionId });
		await loadNotes();
	};

	onMount(() => {
		loadNotes();
		activityVm.setTickInterval();
		return () => {
			activityVm.clearTickInterval();
		};
	});
</script>

{#snippet noteCard(note: GameNote)}
	<li class="bg-background-1 mb-2 p-4">
		<p class="text-lg font-semibold">{note.Title}</p>
		<p class="text-md mb-2">{note.Content}</p>
		<p class="text-sm opacity-70">{new Date(note.CreatedAt).toLocaleString()}</p>
	</li>
{/snippet}

<NoteEditor
	currentNote={noteEditorHandler.currentNote}
	handleOnChange={handleOnNoteChange}
	handleClose={noteEditorHandler.closeNoteEditor}
/>
<BaseAppLayout>
	<Header>
		{#snippet action()}
			<LightButton onclick={() => history.back()}>
				<ArrowLeft />
			</LightButton>
		{/snippet}
	</Header>
	<Main bottomNav={false}>
		{#if pageVm.game}
			<div class="mb-6 flex flex-row gap-4">
				<img
					src={getPlayniteGameImageUrl(pageVm.game.CoverImage)}
					alt={`${pageVm.game.Name} cover image`}
					loading="lazy"
					class="h-7/8 w-26 object-cover"
				/>
				<div class="grow-1">
					{#if isThisGameActive}
						<p>
							{m.game_journal_you_are_playing()}
							<br />
							<span class="text-3xl font-bold">{pageVm.game.Name}</span>
						</p>
						<Divider />
						<p class="text-2xl">
							{getPlaytimeInHoursMinutesAndSeconds(activityVm.inProgressSessionPlaytime!)}
						</p>
					{:else}
						<p class="text-3xl font-bold">{pageVm.game.Name}</p>
						<Divider />
					{/if}
					<small class="text-sm opacity-70">
						{#if todaySessionsCount === 1}
							{m.game_journal_sessions_today_singular({ count: todaySessionsCount })}
						{:else}
							{m.game_journal_sessions_today_plural({ count: todaySessionsCount! })}
						{/if}
					</small>
				</div>
			</div>
		{/if}
		<section class="mb-6">
			<h1 class="text-xl font-semibold">{m.game_journal_title_notes()}</h1>
			<Divider class="border-1 mb-4" />
			{#each notesSignal.notes as note (note.Id)}
				<ul class="">
					{@render noteCard(note)}
				</ul>
			{/each}
		</section>
		<section class="mb-6 font-semibold">
			<h1 class="text-xl">{m.game_journal_title_links()}</h1>
			<Divider class="border-1 mb-4" />
		</section>
		<LightButton onclick={() => noteEditorHandler.openNoteEditor()}>
			{m.game_journal_label_add_note()}
		</LightButton>
	</Main>
</BaseAppLayout>
